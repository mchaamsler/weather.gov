import * as leaflet from "https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.esm.js";

const loadLeafletRadar = () => {
  const point = [36.1622, -86.7744];

  const alertBounds = [
    [36.2027, -86.884],
    [36.3842, -86.7508],
    [36.2813, -86.6218],
    [36.1794, -86.8593],
  ];

  const countyBounds = [
    [36.40031051600005, -86.74599456799996],
    [36.39851379400005, -86.74440002399996],
    [36.39561080900006, -86.74139404299996],
    [36.39081192000003, -86.73970031699997],
    [36.38781356800007, -86.73549652099996],
    [36.38521194500004, -86.73279571499995],
    [36.381111145000034, -86.73059844999995],
    [36.37571334800003, -86.72879791299994],
    [36.371612549000076, -86.72699737499994],
    [36.36581039400005, -86.72589874299996],
    [36.36071014400005, -86.72599792499994],
    [36.35741043100006, -86.72469329799998],
    [36.34801101700003, -86.72349548299997],
    [36.34341049200003, -86.72119903599997],
    [36.33931350700004, -86.71859741199995],
    [36.33821106000005, -86.71689605699999],
    [36.33561325100004, -86.71360015899995],
    [36.33321380600006, -86.70829772899998],
    [36.33031082200006, -86.70669555699999],
    [36.32691192600004, -86.70249938999996],
    [36.327613831000065, -86.69919586199995],
    [36.325412750000055, -86.69649505599995],
    [36.32151031500007, -86.69680023199999],
    [36.319911957000045, -86.68869781499995],
    [36.31811142000004, -86.68739318799999],
    [36.31711196900005, -86.68439483599997],
    [36.31591033900003, -86.67989349399994],
    [36.315711975000056, -86.67599487299998],
    [36.312412262000066, -86.67299652099996],
    [36.309112549000076, -86.67199706999997],
    [36.30341339100005, -86.66649627699996],
    [36.30141067500006, -86.66829681399997],
    [36.29681396500007, -86.65559387199994],
    [36.288112640000065, -86.64199829099994],
    [36.27111053500005, -86.64259338399995],
    [36.265010834000066, -86.64129638699995],
    [36.25461196900005, -86.63779449499998],
    [36.248912811000025, -86.62189483599997],
    [36.24541091900005, -86.61559295699999],
    [36.244113922000054, -86.60999298099995],
    [36.245311737000065, -86.59439849899996],
    [36.24241256700003, -86.59309387199994],
    [36.24031066900005, -86.59399414099994],
    [36.23701095600006, -86.59349822999997],
    [36.235912323000036, -86.59069824199997],
    [36.210411072000056, -86.58129882799994],
    [36.194011688000046, -86.57549285899995],
    [36.175811768000074, -86.57139587399996],
    [36.173011780000024, -86.57039642299998],
    [36.16031265300006, -86.56289672899999],
    [36.14611053500005, -86.55609893799999],
    [36.14371109000007, -86.55169677699996],
    [36.14261245700004, -86.55539703399995],
    [36.13521194500004, -86.55500030499996],
    [36.13621139500003, -86.55249786399997],
    [36.13771057100007, -86.54789733899997],
    [36.14081192000003, -86.54239654499997],
    [36.13801193200004, -86.54009246799995],
    [36.13581085200008, -86.53859710699999],
    [36.13861084000007, -86.53399658199999],
    [36.13831329300007, -86.52959442099996],
    [36.140911102000075, -86.52779388399995],
    [36.139213562000066, -86.52539825399998],
    [36.134410858000024, -86.52659606899994],
    [36.12701034500003, -86.52759551999998],
    [36.121913910000046, -86.52949523899997],
    [36.11251068100006, -86.53109741199995],
    [36.112712860000045, -86.53489685099998],
    [36.10931396500007, -86.53569793699995],
    [36.107212067000034, -86.52769470199996],
    [36.10641098000008, -86.52279663099995],
    [36.100410461000024, -86.51539611799996],
    [36.088710785000046, -86.51689910899995],
    [36.08351135300006, -86.51879882799994],
    [36.07821273800005, -86.52009582499994],
    [36.07281112700008, -86.52079772899998],
    [36.069911957000045, -86.52409362799995],
    [36.058113098000035, -86.52499389599996],
    [36.057212830000026, -86.52969360399999],
    [36.05991363500004, -86.53289794899996],
    [36.07391357400007, -86.52749633799993],
    [36.07741165200008, -86.52949523899997],
    [36.07701110800008, -86.53979492199994],
    [36.08711242700008, -86.54599761999998],
    [36.08581161500007, -86.54899597199994],
    [36.08011245700004, -86.54850006099997],
    [36.07791137700008, -86.54649352999996],
    [36.06641387900004, -86.54649352999996],
    [36.06521225000006, -86.55049896199995],
    [36.06561279300007, -86.55739593499999],
    [36.067813873000034, -86.56169891399998],
    [36.06501388500004, -86.56269836399997],
    [36.062713623000036, -86.56409454299995],
    [36.05751419100005, -86.56139373799994],
    [36.054111481000064, -86.56209564199997],
    [36.05181121800007, -86.56509399399994],
    [36.04731369000007, -86.56539916999998],
    [36.03861236600005, -86.56079864499998],
    [36.034812927000075, -86.56339263899997],
    [36.03411102300004, -86.56789398199999],
    [36.03251266500007, -86.57029724099993],
    [36.03011322000003, -86.57279968299997],
    [36.02911377000004, -86.57529449499998],
    [36.02751159700006, -86.57709503199999],
    [36.026313782000045, -86.57899475099998],
    [36.02641296400003, -86.58179473899997],
    [36.02531051600005, -86.58709716799996],
    [36.02371215800008, -86.59149932899999],
    [36.02121353100006, -86.59219360399999],
    [36.01611328100006, -86.59669494599996],
    [36.01451110800008, -86.59919738799994],
    [36.01121139500003, -86.60119628899997],
    [36.01031112700008, -86.60599517799994],
    [36.00971221900005, -86.61229705799997],
    [35.99151229900008, -86.61559295699999],
    [35.99081039400005, -86.60959625199996],
    [35.98711013800005, -86.60999298099995],
    [35.98451232900004, -86.60739898699995],
    [35.98031234700005, -86.60849761999998],
    [35.97551345800008, -86.61039733899997],
    [35.97551345800008, -86.61369323699995],
    [35.972511292000036, -86.61369323699995],
    [35.96781158400006, -86.61439514199998],
    [35.968013763000044, -86.61889648399995],
    [35.971313477000024, -86.61859893799999],
    [35.97301101700003, -86.62749481199995],
    [35.97411346400003, -86.63240051299994],
    [35.97551345800008, -86.64709472699997],
    [35.978012085000046, -86.65249633799993],
    [35.989013672000056, -86.68119811999998],
    [35.99051284800004, -86.68249511699997],
    [35.99281311000004, -86.68489837599998],
    [35.99501037600004, -86.68889617899998],
    [35.99501037600004, -86.69209289599996],
    [36.00231170700005, -86.70349883999995],
    [36.00801086400003, -86.71289825399998],
    [36.00951385500008, -86.72929382299998],
    [36.01031112700008, -86.73309326199995],
    [36.02811050400004, -86.76709747299998],
    [36.032913208000025, -86.77739715599995],
    [36.035011292000036, -86.78399658199999],
    [36.035713196000074, -86.78659820599995],
    [36.03621292100007, -86.78939819299995],
    [36.04461288500005, -86.86539459199997],
    [36.04941177400008, -86.90339660599994],
    [36.05211257900004, -86.92639923099995],
    [36.052612305000025, -86.92919921899994],
    [36.04301071200007, -86.94439697299998],
    [36.03871154800004, -86.95079803499993],
    [36.024711609000065, -86.97319793699995],
    [36.00681304900007, -87.00129699699994],
    [35.99791336100003, -87.01589965799997],
    [35.98931121800007, -87.02769470199996],
    [35.98911285400004, -87.04039764399994],
    [35.996513367000034, -87.04239654499997],
    [36.045612335000044, -87.05410003699996],
    [36.04951095600006, -87.05489349399994],
    [36.04741287200005, -87.04470062299998],
    [36.04431152300003, -87.04369354199997],
    [36.04221344000007, -87.04100036599993],
    [36.05041122400007, -87.04039764399994],
    [36.07791137700008, -87.03889465299994],
    [36.08271408100006, -87.03739929199998],
    [36.087211609000065, -87.03689575199996],
    [36.09351348900003, -87.03799438499999],
    [36.09941101100003, -87.03179931599999],
    [36.101711273000035, -87.02909851099997],
    [36.11981201200007, -87.00709533699995],
    [36.12981414800004, -86.99739837599998],
    [36.17241287200005, -86.99079894999994],
    [36.202812195000035, -86.98489379899996],
    [36.20991134600007, -86.98439788799999],
    [36.21431350700004, -86.98479461699998],
    [36.21401214600007, -86.98249816899994],
    [36.21571350100004, -86.98069763199999],
    [36.217712402000075, -86.98079681399997],
    [36.22521209700005, -86.98410034199998],
    [36.25001144400005, -86.97439575199996],
    [36.27281189000007, -86.95959472699997],
    [36.27641296400003, -86.95669555699999],
    [36.28231048600003, -86.94779968299997],
    [36.30761337300004, -86.93329620399999],
    [36.32521057100007, -86.92359924299996],
    [36.33061218300003, -86.92079925499996],
    [36.357013702000074, -86.91099548299997],
    [36.360313416000054, -86.91029357899998],
    [36.364013672000056, -86.90879821799996],
    [36.365711212000065, -86.90629577599998],
    [36.36921310400004, -86.90769958499999],
    [36.37101364100005, -86.90959930399998],
    [36.372310638000044, -86.91329956099997],
    [36.37761306800007, -86.91459655799997],
    [36.37771225000006, -86.91169738799994],
    [36.380012512000064, -86.91109466599994],
    [36.38291168200004, -86.91309356699998],
    [36.39041137700008, -86.90899658199999],
    [36.38951110800008, -86.90489959699994],
    [36.390113831000065, -86.89869689899996],
    [36.38911056500007, -86.89439392099996],
    [36.38711166400003, -86.89059448199998],
    [36.38341140700004, -86.88629913299997],
    [36.38071060200008, -86.88199615499997],
    [36.37741088900003, -86.87879943799999],
    [36.37401199300007, -86.87859344499998],
    [36.37261200000006, -86.87539672899999],
    [36.373912811000025, -86.86989593499999],
    [36.37171173100006, -86.86639404299996],
    [36.370613098000035, -86.86219787599998],
    [36.38091278100006, -86.86259460399998],
    [36.380210876000035, -86.85289764399994],
    [36.369712830000026, -86.85429382299998],
    [36.367012024000076, -86.85129547099996],
    [36.36631393400006, -86.84819793699995],
    [36.364810944000055, -86.84429931599999],
    [36.36281204200003, -86.84109497099996],
    [36.35801315300006, -86.83649444599996],
    [36.35711288500005, -86.83419799799998],
    [36.35051345800008, -86.82479858399995],
    [36.351913452000076, -86.82089996299999],
    [36.352710724000076, -86.81809997599998],
    [36.35331344600007, -86.81299591099997],
    [36.35471344000007, -86.80999755899995],
    [36.355411530000026, -86.80449676499995],
    [36.35921096800007, -86.79729461699998],
    [36.35981369000007, -86.78769683799999],
    [36.366012573000035, -86.78829956099997],
    [36.369411469000056, -86.79229736299999],
    [36.376010895000036, -86.79089355499997],
    [36.377811432000044, -86.78679656999998],
    [36.382110596000075, -86.78409576399997],
    [36.38411331200007, -86.78179931599999],
    [36.38781356800007, -86.78119659399994],
    [36.38981246900005, -86.78149414099994],
    [36.39261245700004, -86.77289581299999],
    [36.393413544000055, -86.76909637499995],
    [36.39371109000007, -86.76679992699997],
    [36.395111084000064, -86.76419830299994],
    [36.398212433000026, -86.76379394499997],
    [36.40031051600005, -86.76139831499995],
    [36.40011215200008, -86.75729370099998],
    [36.40241241500007, -86.75519561799996],
    [36.40471267700008, -86.75469970699999],
    [36.404613495000035, -86.74849700899995],
    [36.403011322000054, -86.74569702099996],
    [36.40031051600005, -86.74599456799996],
  ];

  const map = leaflet
    .map("weathergov_location_radar")
    .setView([36.1622, -86.7744], 9);

  // Leaflet is managed by a Ukrainian team. The default attribution they put on
  // maps includes a Ukrainian flag to show their national pride. But as an
  // official website of the US Government, that might not be appropriate for
  // us, so turn off the attribution. We're not likely to use Leaflet in the
  // end anyway, but if we do, we'll figure out how to put back attributions
  // without the flag then.
  map.attributionControl.setPrefix("");

  leaflet
    .tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution:
        '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    })
    .addTo(map);

  const locationIcon = leaflet.divIcon({
    className: "weathergov-location-marker",
  });
  leaflet.marker(point, { icon: locationIcon }).addTo(map);

  fetch(
    "https://opengeo.ncep.noaa.gov/geoserver/conus/conus_bref_qcd/ows?service=wms&version=1.1.1&request=GetCapabilities",
  )
    .then((response) => response.text())
    .then((capabilities) => {
      const timeExtents = /<Extent [^>]*name="time"[^>]*>([^<]+)</
        .exec(capabilities)[1]
        .split(",")
        .slice(-30);

      const layers = timeExtents.map((time) => {
        const paneName = `radar-${time.replace(/[:.]/g, "-")}`;
        const pane = map.createPane(paneName);

        const layer = leaflet.tileLayer.wms(
          "https://opengeo.ncep.noaa.gov/geoserver/conus/conus_bref_qcd/ows",
          {
            time,
            layers: "conus_bref_qcd",
            transparent: true,
            format: "image/png",
            opacity: 0.55,
            pane: paneName,
          },
        );
        layer.addTo(map);

        pane.setAttribute("style", "opacity: 0;");
        pane.setAttribute("data-timestamp", time);

        return pane;
      });

      let layer = layers[layers.length - 1];

      const timestampFormatter = new Intl.DateTimeFormat(navigator.language, {
        hour: "numeric",
        minute: "numeric",
      });
      const timestampElement = document.querySelector(
        "#weathergov_location_radar_timestamp",
      );

      let index = 0;
      const nextImage = () => {
        layer.setAttribute("style", "opacity: 0;");
        layer = layers[index];
        layer.setAttribute("style", "opacity: 1;");

        const timestamp = layer.getAttribute("data-timestamp");
        timestampElement.innerText = timestampFormatter.format(
          new Date(Date.parse(timestamp)),
        );

        index = (index + 1) % layers.length;
        // return;

        if (index === 0) {
          setTimeout(nextImage, 3_000);
        } else {
          setTimeout(nextImage, 500);
        }
      };
      // nextImage();
    })
    .finally(() => {
      leaflet.polygon(countyBounds, { color: "yellow" }).addTo(map);
      leaflet.polygon(alertBounds, { color: "red" }).addTo(map);
    });
};

document.addEventListener("DOMContentLoaded", () => {
  loadLeafletRadar();
});
